尚硅谷《云原生Java架构师的第一课K8s+Docker+KubeSphere+DevOps》2021-09-28

https://www.bilibili.com/video/BV13Q4y1C7hS

# P1 云原生实战-课程简介



# P2 云原生实战-云计算简单概念

## 为什么用云平台

- 环境统一
- 按需付费
- 即开即用
- 稳定性强



国内常见云平台：

- 阿里云、百度云、腾讯云、华为云、青云……

国外常见云平台：

- 亚马逊 AWS、微软 Azure

### 1、公有云

> 购买云服务商提供的公共服务器

公有云是最常见的云计算部署类型。公有云资源（例如服务器和存储空间）由第三方云服务提供商拥有和运营，这些资源通过 Internet 提供。在公有云中，所有硬件、软件和其他支持性基础结构均为云提供商所拥有和管理。Microsoft Azure 是公有云的一个示例。

在公有云中，你和其他组织或云“用户”共享相同的硬件、存储和网络设备，并且你可以使用 Web 浏览器访问服务和管理账户。公有云部署通常用于提供基于 Web 的电子邮件、网上办公应用、存储以及测试和开发环境。

公有云优势：

- **成本更低**：无序购买硬件或软件，仅对使用的服务付费
- **无需维护**：维护由服务提供商提供
- **近乎无限制的缩放性**：提供按需资源，可满足业务需求
- **高可靠性**：具备众多服务器，确保免受故障影响。

### 2、私有云

> 自己搭建云平台，或者购买

私有云由专供一个企业或组织使用的云计算资源构成。私有云可在物理上位于组织的现场数据中心，也可由第三方服务提供商托管。但是，在私有云中，服务和基础结构始终在私有网络上进行维护，硬件和软件专供组织使用。

这样，私有云可使组织更加方便地自定义资源，从而满足特定的 IT 需求。私有云的使用对象通常为政府机构、金融机构以及其他具备业务关键性运营且希望对环境拥有更大控制权的中型到大型组织。

私有云优势：

- **灵活性更强**：组织可自定义环境以满足特定业务需求。
- **控制力更强**：资源不与其他组织共享，因此能获得更高的控制力以及更高的隐私级别。
- **可伸缩性更强**：与本地基础结构相比，私有云通常具有更强的可伸缩性。

## 核心架构

### 1、基础概念

- 云服务器作为应用的最终载体
- VPC 为所有云服务器提供网络隔离
- 所有云服务器都是绑定某个私有网络
- 安全组控制每个服务器的防火墙规则
- 公网 IP 使得资源可访问
- 端口转发的方式访问到具体服务器

### 2、实战操作

# P3 云平台 - 阿里云服务器开通流程



# P4 云平台 - 测试安装 nginx 并访问



# P5 云平台 - 服务器的安全组设置

安全组：防火墙相关的端口设置

# P6 云平台 - 按量付费优点



# P7 云平台 - 私有网络 VPC 实战

VPC：私有网络、专有网络

# P8 容器化 - Docker 概念

## 解决的问题

### 1、统一标准

- 应用构建
- 应用分享
- 应用运行
- ……

### 2、资源隔离

- cpu、memory 资源隔离与限制
- 访问设备隔离与限制
- 网络隔离与限制
- 用户、用户组隔离限制
- ……

虚拟化技术：

1. 基础镜像 GB 级别
2. 创建使用稍微复杂
3. 隔离性强
4. 启动速度慢
5. 移植与分享不方便

容器化技术：

1. 基础镜像 MB 级别
2. 创建简单
3. 隔离性强
4. 启动速度秒级
5. 移植与分享方便

## 架构

- Docker_Host: 安装 Docker 的主机
- Docker Daemon：运行在 Docker 主机上的 Docker 后台进程
- Client：提供 Docker 主机的客户端（命令行、UI 等）
- Registry：镜像仓库（Docker Hub）
- Images：镜像，带环境打包好的程序，可以直接启动运行
- Container：容器，由镜像启动起来正在运行中的程序

# P26 Kubernetes - 基础概念 - 简介

## 是什么

> 我们急需一个大规模容器编排系统

Kubernetes 具有以下特性：

- **服务发现和负载均衡**

  Kubernetes 可以使用 DNS 名称或自己的 IP 地址公开容器，如果进入容器的流量很大，Kubernetes 可以负载均衡并分配网络流量，从而使部署稳定。

- **存储编排**

  Kubernetes 允许你自己挂载你选择的存储系统，例如本地存储、公共云提供商等。

- **自动部署和回滚**

  你可以使用 Kubernetes 描述已部署容器的所需状态，它可以以受控的速率将实际状态更改为期望状态。例如，你可以自动化 Kubernetes 来为你的部署创建新容器，删除现有容器并将它们的所有资源用于新容器。

- **自动完成装箱计算**

  Kubernetes 允许你指定每个容器所需 CPU 和内存（RAM）。当容器指定了资源请求时，Kubernetes 可以做出更好的决策来管理容器的资源。

- **自我修复**

  Kubernetes 重新启动失败的容器、替换容器、杀死不响应用户定义的运行状况检查的容器，并且在准备好服务之前不将其通告给客户端。

- **密钥与配置管理**

  Kubernetes 允许你存储和管理敏感信息，例如密码、OAuth 令牌和 SSH 密钥。你可以在不重建容器镜像的情况下部署和更新密钥和应用程序配置，也无需在堆栈配置中暴露密钥

Kubernetes 为你提供了一个可弹性运行分布式系统的框架。Kubernetes 会满足你的扩展要求、故障转移、部署模式等。例如，Kubernetes 可以轻松管理系统的 Canary 部署。

# P27 Kubernetes - 基础概念 - 集群的方式

## 架构

### 1、工作方式

Kubernetes Cluster = N Master Node + N Worker Node

N 主节点 + N 工作节点；N>=1

### 2、组件架构

#### 控制平面组件（Control Plane Components）

控制平面的组件对集群做出全局决策（比如调度），以及检测和响应集群事件（例如，当不满足部署的 `replicas` 字段时，启动新的 Pod）。

控制平面组件可以在集群中的任何节点上运行。然而，为了简单期间，设置脚本通常会在同一个计算机启动所有控制平面组件，并且不会在此计算机上运行用户容器。请参阅使用 Kubeadm 构建高可用性集群中关于多 VM 控制平面设置的示例。

##### kuber-apiserver

API 服务器是 Kubernetes 控制面的组件，该组件公开了 Kubernetes API。API 服务器是 Kubernetes 控制面的前端。

Kubernetes API 服务器的主要实现是 kuber-apiserver。kuber-apiserver 设计上考虑了水平伸缩，也就是说，它可以通过部署多个实例进行伸缩。你可以运行 kuber-apiserver 的多个实例，并在这些实例之间平衡流量。

##### etcd

etcd 是兼具一致性和高可用性的键值数据库，可以作为保存 Kubernetes 所有集群数据的后台数据库。

您的 Kubernetes 集群的 etcd 数据库通常需要有个备份计划。

要了解 etcd 更深层次的信息，请参考 etcd 文档。

##### kube-scheduler

控制平面组件，负责监听新创建的、未指定运行节点（node）的 Pods，选择节点让 Pod 在上面运行。

调度决策考虑的因素包括单个 Pod 和 Pod 集合的资源需求、硬件/软件/策略约束、亲和性和反亲和性规范、数据位置、工作负载间的干扰和最后期限。

##### kube-controller-manager

在主节点上运行控制器的组件。

从逻辑上讲，每个控制器都是一个单独的进程，但是为了降低复杂性，它们都被编译到同一个可执行文件，并在一个进程中运行。

这些控制器包括：

- 节点控制器（Node Controller）：负责在节点出现故障时通知和响应
- 任务控制器（Job Controller）：监测代表一次性任务的 Job 对象，然后创建  Pods 来运行这些任务直至完成
- 端点控制器（Endpoints Controller）：填充端点（Endpoints）对象（即加入 Service 与 Pod）
- 服务账户和令牌控制器（Service Account & Token Controllers）：为新的命名空间创建默认账户和 API 访问令牌

##### cloud-controller-manager

云控制器管理器是指嵌入特定云的控制逻辑的控制平面组件。云控制器管理器允许您链接集群到云提供商的应用编程接口中，并把和该云平台交互的组件与只和您的集群交互的组件分离开。

`cloud-controller-manager` 仅运行特定于云平台的控制回路。如果你在自己的环境中运行 Kubernetes，或者在本地计算机中运行学习环境，所部署的环境中不需要云控制器管理器。

与 `kube-controller-manager` 类似，`cloud-controller-manager` 将若干逻辑上独立的控制回路组合到同一个可执行文件中，供你以同一进程的方式运行。你可以对其执行水平扩容（运行不止一个副本）以提升性能或者增强容错能力。

下面的控制器都包含对云平台驱动的依赖：

- 节点控制器（Node Controller）：用于在节点终止响应后检查云提供商以确定节点是否已被删除
- 路由控制器（Route Controller）：用于在底层云基础架构中设置路由。
- 服务控制器（Service Controller）：用于创建、更新和删除云提供商负载均衡器

#### Node 组件

节点组件在每个节点上运行，维护运行的 Pod 并提供  Kubernetes 运行环境。

##### kubelet

一个在集群中每个节点（node）上运行的代理。它保证容器（containers）都运行在 Pod 中。

kubelet 接收一组通过各类机制提供给它的 PodSpecs，确保这些 PodSpecs 中描述的容器处于运行状态且健康。kubelet 不会管理不是由 Kubernetes 创建的容器。

##### kube-proxy

kube-proxy 是集群中每个节点上运行的网络代理，实现 kubernetes 服务（service）概念的一部分。

kube-proxy 维护节点上的网格规则。这些网格规则允许从集群内部或外部的网络会话与 Pod 进行网络通信。

如果操作系统提供了数据包过滤层并可用的话，kube-proxy 会通过它来实现网格规则。否则，kube-proxy 仅转发流量本身。

# P28 Kubernetes - 基础概念 - 组件交互逻辑动画

# P29 Kubernetes - 基础概念 - 集群安装逻辑

## Kubeadm 创建集群

> 请参照以前 Docker 安装，先提前为所有机器安装 Docker

### 1、安装 kubeadm

- 一台兼容的 Linux 主机。Kubernetes 项目为基于 Debian 和 Red Hat 的 Linux 发行版以及一些不提供包管理器的发行版提供通用的指令。
- 每台机器 2 GB 或更多的 RAM（如果少于这个数字将会影响你应用的运行内存）
- 2 CPU 核或更多
- 集群中所有机器的网络彼此均能相互连接（公网和内网都可以）
  - 设置防火墙放行规则
- 开启机器上某些端口。
  - 内网互信
- 禁用交换分区。为了保证 kubelet 正常工作，你必须禁用交换分区。
  - 永久关闭