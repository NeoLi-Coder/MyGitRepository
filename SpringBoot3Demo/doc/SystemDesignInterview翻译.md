# 前言

我们很高兴您决定加入我们学习系统设计面试。系统设计面试问题是所有技术问题中最难解决的面试。这些问题要求受访者设计软件的体系结构系统，可以是新闻源、谷歌搜索、聊天系统等。这些问题是令人生畏，而且没有特定的模式可循。问题通常很大范围广泛且模糊。流程是开放式的，不明确，没有标准或正确
答复。
公司广泛采用系统设计面试，因为在这些面试中测试的沟通和解决问题的技能与软件工程师的日常工作要求相似。根据受访者如何分析一个模糊的问题以及她如何一步一步地解决这个问题。测试的能力还包括她如何解释想法，与他人讨论，并对系统进行评估和优化。在英语中，使用“she”比“他或她”或在两者之间跳跃更流畅。为了使阅读更容易，我们使用贯穿本书的女性代词。并非有意不尊重男性工程师。

系统设计问题是开放式的。就像在现实世界中一样，有很多系统中的差异和变化。期望的结果是提出一个架构以实现系统设计目标。讨论可能会以不同的方式进行
取决于面试官。一些面试官可能会选择高级架构进行面试各方面；而有些人可能会选择一个或多个领域来关注。通常应充分理解需求、限制和瓶颈，以确定
面试官和被面试者。

本书的目的是提供一种可靠的策略来进行系统设计问题。正确的策略和知识对面试的成功至关重要。

这本书提供了构建可扩展系统的坚实知识。知识越多从阅读这本书中获得的经验，你在解决系统设计方面的问题时就越有能力。

本书还提供了一个关于如何解决系统设计问题的循序渐进的框架。它提供了许多例子来说明系统化的方法，并提供了详细的步骤可以跟随。通过不断的练习，您将具备应对系统设计的能力面试问题。

# 第 1 节：从零到百万用户规模

设计一个支持数百万用户的系统是一项挑战，这是一个需要不断改进和无尽改进的旅程。在本章中，我们构建了一个支持单个用户的系统，并逐步扩大其服务于数百万用户。在阅读完本章之后，您将掌握一些技巧，这将帮助您破解系统设计的面试问题。

## 单服务器设置

千里之行始于足下，建立一个复杂的系统也不例外。从一些简单的事情开始，一切都运行在一台服务器上。图 1-1 显示了一个单个服务器设置的说明，其中所有内容都运行在一台服务器上： web 应用程序、数据库、缓存等。

要理解此设置，调查请求流和流量源会很有帮助。让我们先看一下请求流（图 1-2)

1. 用户可以通过 api.mysite.com 等域名来访问网站。通常，域名系统（DNS）是由第三方提供的付费服务，而不是由我们的服务器托管的。
2. 互联网协议（IP）地址被返回到浏览器或移动应用程序。在该示例中，将返回 IP 地址 15.125.23.214。 
3. 一旦获得了 IP 地址，超文本传输协议（HTTP）[1] 请求将直接发送到您的 web服务器。
4. web 服务器返回 HTML 页面或 JSON 响应以进行呈现。

接下来，让我们检查一下流量源。到 web 服务器的流量来自两个来源： web 应用程序和移动应用程序。

- Web 应用程序：它使用服务器端语言（Java、Python 等）的组合。来处理业务逻辑、存储等，以及用来进行演示的客户端语言（HTML 和 JavaScript）。

- 移动应用： HTTP 协议是移动应用与 web 服务器之间的通信协议。JavaScript 对象表示法（JSON）由于其简单性，是通常用于传输数据的 API 响应格式。一个 JSON 格式的 API 响应示例如下所示：

  ```json
  // GET /users/12 – Retrieve user object for id = 12
  {
      "id": 12,
      "firstName": "John",
      "lastName": "Smith",
      "address": {
          "streetAddress": "21 2nd Street",
          "city": "New York",
          "state": "NY",
          "postalCode": 10021
      },
      "phoneNumbers": [
          "212 555-1234",
          "646 555-4567"
      ]
  }
  ```

## 数据库

随着用户基础的增长，一个服务器是不够的，我们需要多个服务器：一个用于 web /移动流量，另一个用于数据库（图 1-3）。分离 Web /移动流量(web 层）和数据库（数据层）服务器可以独立扩展。

## 使用哪个数据库？

您可以在传统的关系数据库和非关系数据库之间进行选择。让我们来看看他们之间的差异。

关系数据库也被称为关系数据库管理系统（RDBMS）或 SQL 数据库。最流行的版本是 MySQL、Oracle 数据库、PostgreSQL 等。关系数据库在表和行中表示和存储数据。您可以使用跨不同数据库表的 SQL 来执行连接操作。

非关系数据库也被称为 NoSQL 数据库。最受欢迎的产品有 CouchDB、Neo4j、Cassandra、HBase、亚马逊 DynamoDB 等。[2].这些数据库被分为四类：键值存储、图存储、列存储和文档存储。在非关系型数据库中，通常不支持连接（join）操作。

对于大多数开发人员来说，关系数据库是最好的选择，因为它们已经存在了 40 多年，而且从历史上看，它们工作得很好。但是，如果关系数据库不适合特定的用例，那么在关系数据库之外进行探索是非常重要的。非关系数据库可能是正确的选择，如果：

- 您的应用程序需要超低的延迟。
- 您的数据是非结构化的，或者您没有任何关系数据。
- 您只需要序列化和反序列化数据（JSON、XML、YAML等）。
- 您需要存储大量的数据。

## 垂直缩放 vs 水平缩放

垂直缩放（vertical scaling），被称为“scale up”，是指给您的服务器增加更多性能的过程（CPU、RAM 等）。水平缩放称为“scale-out”，允许您通过在资源池中添加更多服务器来扩展。

当流量较低时，垂直缩放是一个很好的选择，而垂直缩放的简单性是其主要优势。不幸的是，它带有严重的局限性。

- 垂直缩放有一个很硬的限制。不可能为一台服务器添加无限的CPU和内存。
- 垂直缩放没有故障转移和冗余性。如果一个服务器宕机，网站/应用程序就会完全宕机。

由于垂直缩放的限制，水平缩放更适合用于大规模应用。

在之前的设计中，用户可以直接连接到 web 服务器。如果 web 服务器处于脱机状态，则用户将无法访问该网站。在另一种情况下，如果许多用户同时访问 web 服务器，并且它达到了 web 服务器的负载限制，那么用户通常会经历较慢的响应或无法连接到服务器。负载平衡器是解决这些问题的最佳技术。

## 负载均衡器

负载均衡器在负载均衡集中定义的 web 服务器之间均匀地分配传入的流量。图 1-4 显示了负载平衡器的工作原理。

如图 1-4 所示，用户直接连接到负载均衡器的公共 IP。有了这个设置，客户端就再也无法直接访问 web 服务器了。为了获得更好的安全性，私有 IP 用于服务器之间的通信。私有 IP 是指只能在同一网络中的服务器之间可访问的 IP 地址；然而，它在互联网上是无法访问的。负载均衡器通过私有 IP 与 web 服务器进行通信。

在图 1-4 中，在添加了一个负载平衡器和第二个 web 服务器后，我们成功地解决了没有发生故障转移的问题，并提高了 web 层的可用性。详细说明如下：

- 如果服务器 1 脱机，那么所有的流量都将被路由到服务器 2。这可以防止网站脱机。我们还将向服务器池中添加一个新的健康的 web 服务器，以平衡负载。
- 如果网站流量的增长迅速，并且两个服务器不足以处理流量，则负载均衡器可以优雅地处理这个问题。您只需要向 web 服务器池中添加更多的服务器，并且负载平衡器就会自动开始向它们发送请求。

现在 web 层看起来不错，那么数据层呢？当前的设计有一个数据库，因此它不支持故障转移和冗余。数据库复制是解决这些问题的一种常用技术。让我们来看看吧。

## 数据库复制

引用维基百科：“数据库复制可以用于许多数据库管理系统，通常在原始（主）和副本（从）之间的主/从关系”[3]。

主数据库通常只支持写操作。从属数据库从主数据库获取数据的副本，并且只支持读取操作。所有数据修改命令都必须发送到主数据库。大多数应用程序需要更高的读写比；因此，系统中从数据库的数量通常大于主数据库的数量。图 1-5 显示了一个具有多个从属数据库的主数据库。

数据库复制的优点：

- 更好的性能：在主从模型中，所有的写入和更新都发生在主节点中；然而，读取操作分布在各个从节点之间。这个模型提高了性能，因为它允许并行处理更多的查询。
- 可靠性：如果您的一个数据库服务器被自然灾害破坏，如台风或地震，数据仍然被保存。您不需要担心数据丢失，因为数据是跨多个位置复制的。
- 高可用性：通过在不同的位置复制数据，即使数据库脱机，您的网站仍然可以运行，因为您可以访问存储在另一个数据库服务器中的数据。

在上一节中，我们将讨论负载平衡器如何帮助提高系统的可用性。我们在这里问同样的问题：如果其中一个数据库脱机了怎么办？图 1-5 中讨论的架构设计可以处理以下情况：

- 如果只有一个从数据库可用，并且它脱机，则读取操作将暂时引导到主数据库。一旦发现问题，新的从数据库将取代旧数据库。如果有多个从数据库可用，则读取操作重定向到其他健康从数据库。一个新的数据库服务器将取代旧的数据库服务器。
- 如果主数据库脱机，一个从数据库将被提升为新的主数据库。所有的数据库操作都将在新的主数据库上临时执行。一个新的从数据库将立即取代旧的从数据库以进行数据复制。在生产系统中，升级新的主数据更为复杂，因为从数据库中的数据可能不是最新的。丢失的数据需要通过运行数据恢复脚本来进行更新。虽然其他一些复制方法，如多主复制和循环复制可以提供帮助，但这些设置更为复杂；他们的讨论超出了这本书的范围。有兴趣的读者应参考所列出的参考资料[4] [5]。

图 1-6 显示了添加负载平衡器和数据库复制后的系统设计。

让我们来看一下设计：

- 用户从 DNS 获得负载均衡器的 IP 地址。
- 一个用户将负载均衡器与此 IP 地址连接起来。
- HTTP 请求被路由到服务器 1 或服务器 2。
- web 服务器从从属数据库中读取用户数据。
- web 服务器会将任何数据修改操作路由到主数据库。这包括写入、更新和删除操作。

现在，您对 web 和数据层有了深入的了解，是时候提高加载/响应时间了。这可以通过添加一个缓存层，并将静态内容（JavaScript/CSS/图像/视频文件）转移到内容传递网络（CDN）来实现。

## 缓存

缓存是一个临时存储区域，它将昂贵的响应或频繁访问的数据的结果存储在内存中，以便更快地提供后续的请求。如图 1-6 所示，每次加载一个新的网页时，都会执行一个或多个数据库调用来获取数据。反复调用数据库对应用程序性能的影响很大。高速缓存可以缓解这个问题。

## 缓存层

缓存层是一个临时的数据存储层，比数据库要快得多。拥有一个单独的缓存层的好处包括更好的系统性能、减少数据库工作负载的能力，以及独立扩展缓存层的能力。图 1-7 显示了一个高速缓存服务器的可能设置：

在收到一个请求后，web 服务器首先检查该缓存是否有可用的响应。如果有，它会将数据发送回客户端。如果没有，它将查询数据库，将响应存储在缓存中，并将其发送回客户端。这种缓存策略称为通读缓存。根据数据类型、大小和访问模式，还可以使用其他缓存策略。之前的一项研究解释了不同的缓存策略是如何工作的[6]。

与缓存服务器的交互很简单，因为大多数缓存服务器都为通用编程语言提供 api。下面的代码片段显示了典型的 mem 缓存 api：

```python
SECONDS = 1
cache.set('myKey', 'hi there', 3600 * SECONDS)
cache.get('myKey')
```

## 考虑使用缓存

以下是在使用高速缓存系统时需要考虑的一些注意事项：

- 决定何时使用高速缓存。当数据经常读取但很少修改时，请考虑使用缓存。由于缓存的数据存储在易失性内存中，因此缓存服务器不适合持久化数据。例如，如果高速缓存服务器重新启动，则内存中的所有数据都将丢失。因此，重要的数据应该保存在持久的数据存储中。
- 过期政策。实施过期策略是一个很好的做法。缓存数据过期，将从缓存中删除。当没有过期策略时，缓存的数据将永久存储在内存中。建议不要使过期日期太短，因为这将导致系统太频繁地从数据库中重新加载数据。同时，建议不要配置过期时间太长，以免数据可能过时。
- 一致性：这涉及到保持数据存储和高速缓存的同步状态。由于数据存储和缓存上的数据修改操作不在单个事务中，因此可能会发生不一致。当跨多个区域进行缩放时，保持数据存储和缓存之间的一致性具有挑战性。有关更多细节，请参考脸书发布的题为“扩展脸书内存缓存”的论文[7]。
- 减轻故障：单个缓存服务器代表一个潜在的单点故障（SPOF），在维基百科中定义如下：“单点故障（SPOF）是系统的一部分，如果它失败，将停止整个系统工作”[8]。因此，建议跨不同的数据中心使用多个高速缓存服务器，以避免使用SPOF。另一种推荐的方法是按一定的百分比过剩供应所需的内存。随着内存使用量的增加，这就提供了一个缓冲区。
- 驱逐策略：一旦缓存已满，任何将项目添加到缓存中的请求都可能导致现有项目被删除。这被称为高速缓存驱逐。最近最少使用的（LRU）是最流行的高速缓存驱逐策略。其他驱逐策略，如最少常用（LFU）或第一出（FIFO），可以用来满足不同的用例。

## 内容分发网络（CDN）

CDN 是一个由地理上分散的服务器组成的网络，用于交付静态内容。CDN 服务器可以缓存静态内容，如图像、视频、CSS、JavaScript 文件等。

动态内容缓存是一个相对较新的概念，并且超出了这本书的范围。它支持缓存基于请求路径、查询字符串、Cookie 和请求头的 HTML 页面。有关此信息，请参考参考材料[9]中提到的文章。这本书重点介绍了如何使用 CDN 来缓存静态内容。

以下是 CDN 在高级级别上的工作方式：当用户访问一个网站时，最接近该用户的 CDN 服务器将提供静态内容。直观地说，来自 CDN 服务器的用户越多，网站加载就越慢。例如，如果 CDN 服务器在旧金山，洛杉矶的用户将比欧洲的用户更快地获得内容。图 1-9 是一个很好的示例，它显示了 CDN 如何改进加载时间。

图 1-10 演示了 CDN 的工作流。

1. 用户 A 尝试通过使用图像 URL 来获取 image.png。该 URL 的域名由 CDN 提供程序提供。以下两个图像 URL 是用于演示亚马逊和 Akamaicdn 上的图像 URL 的外观的示例：
   - https://mysite.cloudfront.net/logo.jpg
   - https://mysite.akamai.com/image-manager/img/logo.jpg
2. 如果 CDN 服务器缓存中没有 image.png，CDN 服务器将从源请求文件，源可以是 web 服务器，也可以是像 Amazon S3 这样的在线存储。
3. 源将 image.png 返回到 CDN 服务器，其中包括可选的 HTTP 头实时时间（TTL），它描述了映像缓存的时间。
4. CDN 缓存图像并将其返回给用户 A。图像一直缓存在 CDN 中，直到 TTL 过期。 
5. 用户 B 发送一个获取相同图像的请求。 
6. 只要 TTL 没有过期，图像就会从缓存中返回。

## 使用 CDN 的考虑事项

- 成本：CDN 由第三方提供商运行，您需要收取进出 CDN 的数据传输费用。缓存不常用的资产不会提供显著的好处，因此您应该考虑将它们移出 CDN。
- 设置适当的缓存过期时间：对于对时间敏感的内容，设置缓存过期时间非常重要。缓存过期时间既不应太长也不应太短。如果它太长，内容可能就不再新鲜了。如果太短，可能会导致内容从原始服务器重新加载到 CDN。
- CDN 回退：你应该考虑你的网站/应用程序如何处理 CDN 失败。如果存在临时的 CDN 中断，客户端应该能够检测到问题并从源请求资源。
- 无效文件：您可以通过执行以下操作之一，在 CDN 文件过期之前从其删除文件：
  - 使用 CDN 供应商提供的 API 使 CDN 对象无效。
  - 使用对象版本控制来服务于对象的不同版本。要版本一个对象，您可以向 URL 添加一个参数，例如版本号。例如，版本号 2 被添加到查询字符串中：image.png?v=2。

图 1-11 显示了添加了 CDN 和高速缓存后的设计。

1. 静态资产（JS、CSS、图像等）不再由 web 服务器提供服务。它们从 CDN 中获取，以获得更好的性能。
2. 通过缓存数据，可以减轻数据库的负载。

## 无状态 Web 层

现在是时候考虑水平缩放 web 层了。为此，我们需要将状态（例如用户会话数据）从 web 层中移动出来。一个好的做法是将会话数据存储在持久存储中，如关系数据库或 NoSQL。集群中的每个 web 服务器都可以从数据库中访问状态数据。这被称为无状态的 web 层。

## 状态体系结构

有状态服务器和无状态服务器有一些关键的区别。有状态服务器从一个请求到下一个请求都会记住客户端数据（状态）。无状态服务器不保存任何状态信息。

图 1-12 显示了一个有状态的体系结构的示例。

在图 1-12 中，用户 A 的会话数据和配置文件图像存储在服务器 1 中。要对用户 A 进行认证，必须将 HTTP 请求路由到服务器 1。如果将请求发送到服务器 2 等其他服务器，则身份验证将失败，因为服务器 2 不包含用户 A 的会话数据。类似地，来自用户 B 的所有 HTTP 请求都必须路由到服务器 2；来自用户 C 的所有请求都必须发送到服务器 3。

问题是来自同一客户端的每个请求必须路由到相同的服务器。这可以在大多数负载平衡器中的粘性会话来完成[10]；然而，这增加了开销。使用这种方法，添加或删除服务器要困难得多。处理服务器故障也是一个挑战。

## 无状态体系结构

图 1-13 显示了一种无状态的体系结构。

在这种无状态体系结构中，来自用户的 HTTP 请求可以发送到任何 web 服务器，这些服务器从共享数据存储中获取状态数据。状态数据存储在一个共享的数据存储器中，并远离 web 服务器。无状态系统更简单、更健壮和可伸缩。

图 1-14 显示了使用无状态 web 层的更新设计。

在图 1-14 中，我们将会话数据从 web 层中移出，并将它们存储在持久性数据存储区中。共享的数据存储可以是一个关系数据库、内存缓存/Redis、NoSQL 等。选择 NoSQL 数据存储是因为它易于缩放。自动缩放是指根据流量负载自动添加或删除 web 服务器。在从 web 服务器中删除状态数据后，通过根据流量负载添加或删除服务器，可以很容易地实现 web 层的自动缩放。

你的网站发展迅速，并吸引了大量的国际用户。为了提高可用性并在更广泛的地理区域内提供更好的用户体验，支持多个数据中心至关重要。

## 数据中心

图 1-15 显示了一个具有两个数据中心的示例设置。在正常运行中，用户被 geoDNS 路由，也称为地理路由，到最近的数据中心，美国东部的分割流量为 x%，美国西部为（100-x）%。geoDNS 是一种 DNS 服务，它允许根据用户的位置将域名解析为 IP 地址。

在发生任何重大的数据中心中断时，我们将所有流量引导到一个健康的数据中心。在图 1-16 中，数据中心 2（US-West）脱机，100% 的流量被传输至数据中心 1（US-East）。

要实现多数据中心的设置，必须解决几个技术挑战：

- 流量重定向：需要有效的工具来将流量引导到正确的数据中心。GeoDNS 可以根据用户所在的位置将流量引导到最近的数据中心。
- 数据同步：来自不同地区的用户可以使用不同的本地数据库或缓存。在故障转移的情况下，流量可能会被路由到数据不可用的数据中心。一种常见的策略是跨多个数据中心复制数据。之前的一项研究显示了 Netflix 如何实现异步多数据中心复制[11]。
- 测试和部署：通过多数据中心的设置，在不同的地点测试您的网站/应用程序是很重要的。自动化部署工具对于保持所有数据中心的服务一致性至关重要[11]。

为了进一步扩展我们的系统，我们需要解耦系统的不同组件，以便它们可以独立地缩放。消息传递队列是许多现实世界的分布式系统用来解决这一问题的关键策略。

## 消息队列

消息队列是存储在内存中的持久组件，它支持异步通信。它作为一个缓冲区，并分发异步请求。消息队列的基本架构很简单。输入服务，称为生产者/发布者，它创建消息，并将它们发布到消息队列中。其他服务或服务器，称为消费者/订阅者，连接到队列，并执行由消息定义的操作。该模型如图 1-17 所示。

解耦使消息队列成为构建可伸缩和可靠的应用程序的首选体系结构。使用消息队列，当使用者无法处理该队列时，生产者可以将消息发布到该队列。即使生产者不可用，消费者也可以从队列中读取消息。

考虑以下用例：您的应用程序支持照片定制，包括裁剪、锐化、模糊等。这些定制任务需要一段时间来完成。在图 1-18 中，web 服务器会将照片处理作业发布到消息队列中。照片处理工作者从消息队列中获取作业，并异步地执行照片定制任务。生产者和消费者可以独立地进行缩放。当队列的大小变大时，会添加更多的工作者，以减少处理时间。但是，如果队列大部分时间都是空的，则可以减少工作者的数量。

## 日志记录、度量、自动化

当使用运行在一些服务器上的小网站时，日志记录、指标和自动化支持是很好的实践，但不是必要的。然而，现在你的网站已经发展为服务于一个大型企业，投资于这些工具是至关重要的。

日志记录：监视错误日志很重要，因为它有助于识别系统中的错误和问题。您可以在每个服务器级别的错误日志，或者使用工具将它们聚合到集中服务，以便于搜索和查看。

指标：收集不同类型的指标有助于帮助我们获得业务见解，并了解系统的健康状况。以下一些指标是有用的：

- 主机级指标：CPU、内存、磁盘I/O等。
- 聚合级别指标：例如，整个数据库层、高速缓存层等的性能。
- 关键业务指标：每日活跃用户、留存率、收入等。

自动化：当一个系统变得大而复杂时，我们需要构建或利用自动化工具来提高生产率。持续集成是一种很好的实践，其中每个代码签入都通过自动化进行验证，允许团队及早发现问题。此外，自动化您的构建、测试、部署过程等等。可以显著提高开发人员的生产力。

## 添加消息队列和不同的工具

图 1-19 显示了更新后的设计。由于空间的限制，图中只显示了一个数据中心。

1. 该设计包括一个消息队列，这有助于使系统更松散地耦合和故障弹性。 
2. 其中包括日志记录、监控、度量标准和自动化工具

随着数据的不断增长，数据库就会越来越超载。是时候缩放数据层了。

## 数据库缩放

数据库缩放有两种主要的方法：垂直缩放和水平缩放。

## 垂直缩放

垂直缩放，也被称为向上缩放，是通过增加更多的功率（CPU、RAM、磁盘等）来进行的缩放。到一个现有的机器。这里有一些功能强大的数据库服务器。根据 Amazon 关系数据库服务（RDS）[12]，您可以获得一个具有 24 TB 内存的数据库服务器。这种功能强大的数据库服务器可以存储和处理大量的数据。例如，stackoverflow.com 在 2013 年每月有超过 1000 万的独立访问者，但它只有一个主数据库[13]。然而，垂直缩放也带有一些严重的缺点：

- 你可以添加更多的 CPU、RAM 等。到您的数据库服务器，但有硬件限制。如果您有一个很大的用户基础，那么单台服务器是不够的。
- 单点故障的风险更大。
- 垂直缩放的总成本较高。功能强大的服务器要贵得多。

## 水平缩放

水平缩放，也称为分片，是添加更多服务器的做法。图 1- 20 将垂直缩放和水平缩放进行了比较。

分片将大型数据库分离成更小、更容易管理的部分，称为片（shards）。每个片共享相同的模式（schema），尽管每个片上的实际数据对片是唯一的。

图 1-21 显示了一个分片数据库的示例。用户数据根据用户 id 分配给数据库服务器。每当访问数据时，将使用哈希函数来查找相应的碎片。在我们的示例中，user_id % 4 被用作哈希函数。如果结果等于 0，则片 0 用于存储和获取数据。如果结果等于1，则使用片1。同样的逻辑也适用于其他的片。

图 1-22 显示了分形数据库中的用户表。

在实施分片策略时，需要考虑的最重要的因素是分片键的选择。分片键（称为分区键）由一个或多个决定数据如何分布的列组成。如图 1-22 所示，“user_id”是分片键。分片键允许您通过将数据库查询路由到正确的数据库来有效地检索和修改数据。在选择分片键时，最重要的标准之一是选择一个可以均匀分布数据的键。

分片是一种扩展数据库的伟大技术，但它远不是一个完美的解决方案。它给这个系统带来了复杂性和新的挑战：

**重分片数据**：当 1) 由于快速增长，一个单一的片不能再保存更多的数据时，就需要重分片数据。2) 由于数据分布不均匀，某些片可能会比其他片更快地经历片耗尽（shard exhaustion）。当片耗尽发生时，它需要更新分片函数和移动数据。一致性散列是解决这个问题的一种常用技术，这将在第 5 章中讨论。

**名人问题**：这也被称为热点键问题。对特定片的过度访问可能会导致服务器过载。想象一下，凯蒂·佩里、贾斯汀·比伯和 Lady Gaga 的数据都在同一个片。对于社交应用程序来说，这些片将被阅读操作所淹没。为了解决这个问题，我们可能需要为每个名人分配一块片。每个片甚至可能需要进一步的分割。

**连接和去规范化**：一旦一个数据库已经跨多个服务器进行了共享，就很难跨数据库片执行连接操作。一个常见的解决方法是将数据库去规格化，以便可以在单个表中执行查询。

在图 1-23 中，我们分割了数据库，以支持快速增长的数据流量。同时，一些非关系功能被移到 NoSQL 数据存储中，以减少数据库负载。这里有一篇介绍了许多 NoSQL [14] 用例的文章。

## 数百万用户及以上的用户

缩放一个系统是一个迭代的过程。重复我们在这一章中学到的东西可以让我们走得更远。需要更多的微调和新的策略来扩展超过数百万用户。例如，您可能需要优化系统，并将系统解耦到更小的服务。本章中所学到的所有技术都应该为应对新的挑战提供一个良好的基础。在这一章中，我们总结了我们如何扩展系统以支持数百万用户：

- 保持web层无状态
- 在每个层构建冗余
- 尽可能缓存数据
- 支持多个数据中心
- 将静态资产放在CDN主机
- 通过分片进行数据层缩放
- 分割各个层到单独的服务
- 监控您的系统和使用自动化工具

祝贺你能走到这一步！现在拍拍自己的背。干得好！

# 第 2 节：粗略估计

在系统设计面试中，有时会要求您使用粗略估计（back-of-the-envelope estimation）来估计系统容量或性能要求。据谷歌高级研究员 Jeff Dean 说，“粗略估计是你结合使用思想实验和通用性能数字来创建的估计，以良好地了解哪些设计将满足你的需求”[1]。

您需要有良好的可伸缩性基础，以有效地执行粗略估计。我们应该很好地理解以下概念：2 的次方 [2]、每个程序员都应该知道的延迟号和可用性号。

## 二的次方

尽管在处理分布式系统时，数据量可能会变得巨大，但计算归根结底是基础。为了获得正确的计算，关键是要知道使用 2 的幂的数据量单位。一个字节是一个 8 位的序列。ASCII 字符使用一个字节的内存（8 位）。下表解释了数据量单位（表 2-1）。

| 次方 | 约等于值 | 全名                 | 简写名 |
| ---- | -------- | -------------------- | ------ |
| 10   | 一千     | 1 千字节（Kilobyte） | 1 KB   |
| 20   | 一百万   | 1 兆字节（Megabyte） | 1 MB   |
| 30   | 十亿     | 1 吉字节（Gigabyte） | 1 GB   |
| 40   | 一万亿   | 1 太字节（Terabyte） | 1 TB   |
| 50   | 一千万亿 | 1 拍字节（Petabyte） | 1 PB   |

## 每个程序员都应该知道的延迟数

来自谷歌的 Dean 博士揭示了 2010 年[1]中典型计算机操作的长度。随着计算机变得更快和更强大，一些数字已经过时了。然而，这些数字仍然能够让我们了解不同计算机操作的速度和缓慢。

| 操作名                             | 时间                    |
| ---------------------------------- | ----------------------- |
| L1 缓存引用                        | 0.5 ns                  |
| 分支预测错误                       | 5 ns                    |
| L2 缓存引用                        | 7 ns                    |
| 互斥锁/解锁                        | 100 ns                  |
| 主存引用                           | 100 ns                  |
| 使用 Zippy 压缩 1K 字节            | 10,000 ns = 10 μs       |
| 通过 1 Gbps 网络发送 2K 字节       | 20,000 ns = 20 μs       |
| 从内存中连续读取 1 MB              | 250,000 ns = 250 μs     |
| 在同一数据中心内的往返             | 500,000 ns = 500 μs     |
| 磁盘寻道                           | 10,000,000 ns = 10 ms   |
| 从网络连续读取 1 MB                | 10,000,000 ns = 10 ms   |
| 从磁盘连续读取 1 MB                | 30,000,000 ns = 30 ms   |
| 发包 CA（加利福尼亚）-> 荷兰 -> CA | 150,000,000 ns = 150 ms |

一位谷歌软件工程师开发了一个工具来可视化迪恩博士的数字。该工具还考虑到了时间因素。图 2-1 显示了截至 2020 年的可视化延迟数（数据来源：参考材料[3])。

通过分析图 2-1 中的数字，我们得出以下结论：

- 内存速度快，但磁盘速度慢。
- 尽可能避免进行磁盘寻道。
- 简单的压缩算法速度很快。
- 如果可能的话，在将数据发送到互联网之前压缩数据。
- 数据中心通常位于不同的区域，在它们之间发送数据需要时间。

## 可用性数字

高可用性是指系统在所期望的长时间持续运行的能力。高可用性是以百分比来衡量的，100% 表示服务的停机时间为 0。大多数服务下降在 99% 到 100% 之间。

服务级别协议（SLA）是表示服务提供者的常用术语。这是您（服务提供商）和您的客户之间的协议，该协议正式定义了您的服务将提供的正常运行时间水平。云服务提供商 Amazon [4]、谷歌[5]和微软[6]将其 SLA 设置在 99.9% 或以上。正常运行时间传统上以 9 个为单位来衡量。9 个数字越多越好。如表 2-3 所示，9 的数量与预期的系统停机时间相关。

| 可用性 % | 平均每天停机时间 | 平均每年停机时间 |
| -------- | ---------------- | ---------------- |
| 99%      | 14.40 分钟       | 3.65 天          |
| 99.9%    | 1.44 分钟        | 8.77 小时        |
| 99.99%   | 8.64 秒          | 52.60 分钟       |
| 99.999%  | 864.00 毫秒      | 5.26 分钟        |
| 99.9999% | 86.40 毫秒       | 31.56 秒         |

## 示例：估计推特的 QPS 和存储需求

请注意，以下数字仅用于本练习，因为它们不是推特上的真实数字。

假设：

- 活跃用户为每月 3 亿。
- 50% 的用户每天都在使用推特。
- 用户平均每天发布 2 条推特。
- 10% 的推文包含多媒体。
- 数据存储时间 5 年

估计：

每秒查询次数（Query per second，QPS）估计：

- 每天活跃用户（Daily active users，DAU）= 3 亿 * 50 % = 1.5 亿
- 推特 QPS = 1.5 亿 * 2 推特 / 24 小时 / 3600 秒 = ~3500
- 查看 QPS = 2 * QPS = ~7000

这里我们将只评估多媒体存储

- 平均推特大小：
  - 推特 id 64 字节
  - 文本 140 字节
  - 多媒体 1 MB
- 多媒体存储：1.5 亿 * 2 * 10 % * 1 MB = 30 TB 每天
- 5 年多媒体存储：30 TB * 365 * 5 = ~55 PB

## 提示

粗略估计就是关于这个过程的。解决问题比取得结果更重要。面试官可能会测试你解决问题的能力。以下是一些提示：

- 取整和近似。在面试过程中，很难执行复杂的数学操作。例如，“99987/9.1”的结果是什么？没有必要花宝贵的时间来解决复杂的数学问题。精度不是预期的。最好使用整数和近似值。前面的除法问题可以简化为：“100000/10”。
- 写下你的假设。写下你的假设以供以后引用是个好主意。
- 标记你的单位。当你写下“5”时，它是指 5 KB 还是 5 MB？你可能会把自己搞混了。写下单位，因为“5MB”有助于消除歧义。
- 通常要求的粗略估计： QPS、峰值 QPS、存储、缓存、服务器数量等。你可以在准备面试时练习这些计算。熟能生巧。

祝贺你能走到这一步！现在拍拍自己的背。干得好！

# 第 3 节：系统设计面试的框架

你刚刚在你梦想中的公司得到了一个令人垂涎的现场面试。招聘协调员会给你发送当天的时间表。浏览一下列表，你会感觉很好，直到你的目光落在这个面试环节-系统设计面试。

系统设计面试通常会令人生畏。它可能就像“设计一个著名的产品X？”一样模糊。这些问题都很模棱两可，而且似乎过于宽泛。你的疲倦是可以理解的。毕竟，怎么能在一个小时内设计出一个需要数百数千名工程师制造的流行产品呢？

好消息是，没有人希望你这么做。现实世界的系统设计非常复杂的。例如，谷歌搜索看似简单；然而，支持这种简单性的技术数量确实是惊人的。如果没有人期望你在一个小时内设计出一个真实世界的系统，那么系统设计面试有什么好处呢？

系统设计访谈模拟了现实生活中的问题解决，两个同事合作解决一个模棱两可的问题，并提出一个满足他们目标的解决方案。这个问题是开放式的，而且没有一个完美的答案。与你在设计过程中投入的工作相比，最终的设计就不那么重要。这允许您展示您的设计技能，捍卫您的设计选择，并以建设性的方式回应反馈。

让我们翻翻桌子，考虑一下面试官走进会议室迎接你时脑子想的是什么。面试官的主要目标是准确地评估你的能力。她最不希望做的是给出一个不确定的评估，因为会议进展不佳，而且没有足够的信号。面试官在系统设计面试中是在寻找什么？

许多人认为，系统设计面试完全都是关于一个人的技术设计技能。这远不止于此。一个有效的系统设计面试提供了一个人的协作、在压力下工作以及建设性地解决模糊性的能力。问好问题的能力也是一项必不可少的技能，许多面试官特别寻找这种技能。

一个好的面试官也会寻找危险信号。过度工程是许多工程师的一种真正的疾病，因为他们喜欢设计的纯度，而忽略了权衡。他们往往不到过度设计系统的复合成本，许多公司为这种无知付出了高昂的代价。您当然不想在系统设计面试中展示这种趋势。其他的危险信号还包括心胸狭窄、固执等。

在本章中，我们将介绍一些有用的技巧，并介绍一个简单而有效的框架来解决系统设计面试问题。

## 有效系统设计面试的 4 步步骤

每个系统设计面试都是不同的。一个伟大的系统设计面试是开放式的，没有一刀切的解决方案。然而，在每个系统设计访谈中都有一些步骤和共同点。